{% extends 'base.html' %}

{% block title %}Chẩn đoán triệu chứng AI - HealthFirst{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
    }

    body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
    }

    .hero-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
        color: white;
        padding: 60px 0;
        margin-bottom: 40px;
    }

    .hero-content {
        text-align: center;
    }

    .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .hero-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 30px;
    }

    .hero-features {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
    }

    .hero-feature {
        text-align: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        min-width: 150px;
    }

    .hero-feature-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--warning-color);
    }

    .hero-feature-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .hero-feature-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .diagnosis-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 40px;
    }

    .card-header {
        background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .card-header h2 {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
    }

    .card-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }

    .card-body {
        padding: 40px;
    }

    .form-section {
        margin-bottom: 30px;
    }

    .form-section h4 {
        color: var(--dark-color);
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .form-section h4 i {
        margin-right: 10px;
        color: var(--primary-color);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
        display: block;
    }

    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 12px 15px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        outline: none;
    }

    .symptoms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .symptom-btn {
        background: var(--light-color);
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 12px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        color: var(--dark-color);
    }

    .symptom-btn:hover {
        border-color: var(--primary-color);
        background: rgba(13, 110, 253, 0.1);
        transform: translateY(-2px);
    }

    .symptom-btn.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    }

    .load-more-btn {
        background: var(--info-color);
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .load-more-btn:hover {
        background: #138496;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
    }

    .diagnose-btn {
        background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 15px 40px;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 0 auto;
    }

    .diagnose-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }

    .diagnose-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    .results-section {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 40px;
        margin-top: 40px;
        display: none;
    }

    .results-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .results-header h3 {
        color: var(--success-color);
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .disease-item {
        background: var(--light-color);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        border-left: 5px solid var(--primary-color);
    }

    .disease-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    .confidence-bar {
        background: #e9ecef;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }

    .confidence-fill {
        background: linear-gradient(90deg, var(--success-color) 0%, var(--warning-color) 100%);
        height: 100%;
        transition: width 0.5s ease;
    }

    .alert-info {
        background: rgba(23, 162, 184, 0.1);
        border: 1px solid var(--info-color);
        border-radius: 10px;
        padding: 20px;
        margin-top: 30px;
    }

    .alert-info h6 {
        color: var(--info-color);
        margin-bottom: 15px;
    }

    .alert-info ul {
        margin-bottom: 0;
        padding-left: 20px;
    }

    .alert-info li {
        margin-bottom: 8px;
        color: var(--dark-color);
    }

    .login-required {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 40px;
        text-align: center;
        margin-top: 40px;
    }

    .login-required i {
        font-size: 4rem;
        color: var(--warning-color);
        margin-bottom: 20px;
    }

    .login-required h4 {
        color: var(--dark-color);
        margin-bottom: 15px;
    }

    .login-required p {
        color: var(--secondary-color);
        margin-bottom: 25px;
        font-size: 1.1rem;
    }

    .login-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn-login {
        background: var(--primary-color);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-login:hover {
        background: #0056b3;
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }

    .btn-register {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-register:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        text-decoration: none;
    }

    @media (max-width: 768px) {
        .hero-title {
            font-size: 2rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .symptoms-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .card-body {
            padding: 20px;
        }
        
        .login-buttons {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="main-container">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-robot me-3"></i>Chẩn đoán triệu chứng AI
            </h1>
            <p class="hero-subtitle">
                Hệ thống AI thông minh tích hợp máy học với cơ sở dữ liệu y tế chuyên nghiệp
            </p>
            <div class="hero-features">
                <div class="hero-feature">
                    <div class="hero-feature-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="hero-feature-value">95%</div>
                    <div class="hero-feature-label">Độ chính xác</div>
                </div>
                <div class="hero-feature">
                    <div class="hero-feature-icon">
                        <i class="fas fa-disease"></i>
                    </div>
                    <div class="hero-feature-value">40+</div>
                    <div class="hero-feature-label">Bệnh phổ biến</div>
                </div>
                <div class="hero-feature">
                    <div class="hero-feature-icon">
                        <i class="fas fa-stethoscope"></i>
                    </div>
                    <div class="hero-feature-value">130+</div>
                    <div class="hero-feature-label">Triệu chứng</div>
                </div>
                <div class="hero-feature">
                    <div class="hero-feature-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="hero-feature-value">&lt; 2s</div>
                    <div class="hero-feature-label">Xử lý</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="main-container">
    {% if user %}
        <!-- AI Diagnosis Form -->
        <div class="diagnosis-card">
            <div class="card-header">
                <h2><i class="fas fa-stethoscope me-3"></i>Chẩn đoán AI</h2>
                <p>Tích hợp thông tin hồ sơ để tăng độ chính xác</p>
            </div>
            
            <div class="card-body">
                <form id="aiDiagnosisForm">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4><i class="fas fa-user"></i>Thông tin cơ bản</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Tuổi</label>
                                <input type="number" class="form-control" id="patientAge" 
                                       value="{{ user.age or '' }}" min="1" max="120" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Số ngày có triệu chứng</label>
                                <input type="number" class="form-control" id="daysSick" 
                                       min="1" max="365" required>
                            </div>
                        </div>
                    </div>

                    <!-- Symptoms Selection -->
                    <div class="form-section">
                        <h4><i class="fas fa-list-check"></i>Chọn triệu chứng</h4>
                        <p class="text-muted mb-3">Chọn tất cả triệu chứng bạn đang gặp phải (có thể chọn nhiều)</p>
                        
                        <div id="symptomGrid" class="symptoms-grid">
                            <!-- Symptoms will be loaded here -->
                        </div>
                        
                        <div class="text-center">
                            <button type="button" class="load-more-btn" id="loadMoreSymptoms">
                                <i class="fas fa-plus"></i>Tải thêm triệu chứng
                            </button>
                        </div>
                    </div>

                    <!-- Custom Symptoms -->
                    <div class="form-section">
                        <h4><i class="fas fa-edit"></i>Triệu chứng khác</h4>
                        <div class="form-group">
                            <label class="form-label">Mô tả thêm các triệu chứng khác nếu có</label>
                            <textarea class="form-control" id="customSymptoms" rows="3" 
                                      placeholder="Mô tả chi tiết các triệu chứng khác bạn đang gặp phải..."></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="diagnose-btn" id="diagnoseBtn">
                            <i class="fas fa-robot"></i>Bắt đầu chẩn đoán AI
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div id="diagnosisResults" class="results-section">
            <div class="results-header">
                <h3><i class="fas fa-check-circle me-2"></i>Kết quả chẩn đoán</h3>
                <p class="text-muted">Dựa trên triệu chứng và thông tin hồ sơ của bạn</p>
            </div>
            <div id="resultsContent">
                <!-- Results will be displayed here -->
            </div>
        </div>

    {% else %}
        <!-- Login Required -->
        <div class="login-required">
            <i class="fas fa-user-lock"></i>
            <h4>Đăng nhập để sử dụng chẩn đoán AI</h4>
            <p>
                Để sử dụng chẩn đoán AI với độ chính xác cao, vui lòng đăng ký tài khoản hoặc đăng nhập.<br>
                Hệ thống sẽ tích hợp thông tin hồ sơ sức khỏe để đưa ra chẩn đoán chính xác hơn.
            </p>
            <div class="login-buttons">
                <a href="{{ url_for('auth.login') }}" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i>Đăng nhập
                </a>
                <a href="{{ url_for('auth.register') }}" class="btn-register">
                    <i class="fas fa-user-plus"></i>Đăng ký tài khoản
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedSymptoms = [];
    let allSymptoms = [];
    let currentPage = 1;
    const symptomsPerPage = 20;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('patientAge')) {
            loadSymptoms();
            setupEventListeners();
        }
    });

    function loadSymptoms() {
        fetch('/api/ai/symptoms')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allSymptoms = data.symptoms;
                    displaySymptoms();
                }
            })
            .catch(error => {
                console.error('Error loading symptoms:', error);
                // Fallback symptoms
                allSymptoms = [
                    'Sốt', 'Ho', 'Đau họng', 'Sổ mũi', 'Đau đầu', 'Mệt mỏi',
                    'Đau bụng', 'Buồn nôn', 'Nôn', 'Tiêu chảy', 'Táo bón',
                    'Đau lưng', 'Đau khớp', 'Phát ban', 'Ngứa', 'Chóng mặt',
                    'Khó thở', 'Đau ngực', 'Tim đập nhanh', 'Mất ngủ'
                ];
                displaySymptoms();
            });
    }

    function displaySymptoms() {
        const startIndex = (currentPage - 1) * symptomsPerPage;
        const endIndex = startIndex + symptomsPerPage;
        const pageSymptoms = allSymptoms.slice(startIndex, endIndex);
        
        const grid = document.getElementById('symptomGrid');
        grid.innerHTML = pageSymptoms.map(symptom => `
            <button type="button" class="symptom-btn" 
                    data-symptom="${symptom}" onclick="toggleSymptom('${symptom}')">
                ${symptom}
            </button>
        `).join('');
        
        updateSelectedSymptomsDisplay();
    }

    function toggleSymptom(symptom) {
        const index = selectedSymptoms.indexOf(symptom);
        if (index > -1) {
            selectedSymptoms.splice(index, 1);
        } else {
            selectedSymptoms.push(symptom);
        }
        updateSelectedSymptomsDisplay();
    }

    function updateSelectedSymptomsDisplay() {
        document.querySelectorAll('.symptom-btn').forEach(btn => {
            const symptom = btn.dataset.symptom;
            if (selectedSymptoms.includes(symptom)) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });
    }

    function setupEventListeners() {
        document.getElementById('loadMoreSymptoms').addEventListener('click', function() {
            currentPage++;
            displaySymptoms();
        });

        document.getElementById('aiDiagnosisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performDiagnosis();
        });
    }

    function performDiagnosis() {
        if (selectedSymptoms.length === 0) {
            alert('Vui lòng chọn ít nhất một triệu chứng');
            return;
        }

        const formData = {
            age: document.getElementById('patientAge').value,
            days_sick: document.getElementById('daysSick').value,
            symptoms: selectedSymptoms,
            custom_symptoms: document.getElementById('customSymptoms').value,
            profile_data: {
                gender: '{{ user.gender or "" }}',
                height: parseInt('{{ user.height or 0 }}') || 0,
                weight: parseInt('{{ user.weight or 0 }}') || 0,
                blood_type: '{{ user.blood_type or "" }}',
                allergies: '{{ user.allergies or "" }}',
                medications: '{{ user.medications or "" }}',
                medical_history: '{{ user.medical_history or "" }}'
            }
        };

        // Show loading
        const diagnoseBtn = document.getElementById('diagnoseBtn');
        const originalText = diagnoseBtn.innerHTML;
        diagnoseBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang chẩn đoán...';
        diagnoseBtn.disabled = true;

        // Hide previous results
        document.getElementById('diagnosisResults').style.display = 'none';

        fetch('/api/ai/quick-diagnosis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.diagnosis);
                saveDiagnosisToProfile(formData, data.diagnosis);
            } else {
                alert('Có lỗi xảy ra: ' + (data.error || 'Không thể chẩn đoán'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi chẩn đoán');
        })
        .finally(() => {
            // Restore button
            diagnoseBtn.innerHTML = originalText;
            diagnoseBtn.disabled = false;
        });
    }

    function displayResults(diagnosis) {
        const resultsDiv = document.getElementById('resultsContent');
        
        let html = '<div class="mb-4">';
        html += '<h5 class="text-success mb-3"><i class="fas fa-check-circle me-2"></i>Chẩn đoán hoàn tất</h5>';
        html += '<p class="text-muted">Dựa trên triệu chứng và thông tin hồ sơ của bạn, AI đã đưa ra các chẩn đoán sau:</p>';
        html += '</div>';

        if (diagnosis.diseases && diagnosis.diseases.length > 0) {
            diagnosis.diseases.forEach((disease, index) => {
                const confidence = disease.confidence || 0;
                html += `
                    <div class="disease-item">
                        <div class="disease-name">${disease.name}</div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Độ tin cậy</small>
                            <span class="badge bg-success">${confidence}%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence}%"></div>
                        </div>
                        <div class="mt-2">
                            <strong>Triệu chứng chính:</strong> ${disease.symptoms.join(', ')}
                        </div>
                        ${disease.description ? `<div class="mt-2"><strong>Mô tả:</strong> ${disease.description}</div>` : ''}
                        ${disease.recommendations ? `<div class="mt-2"><strong>Khuyến nghị:</strong> ${disease.recommendations}</div>` : ''}
                    </div>
                `;
            });
        } else {
            html += '<div class="text-center py-4">';
            html += '<i class="fas fa-info-circle fa-3x text-muted mb-3"></i>';
            html += '<h5 class="text-muted">Không tìm thấy chẩn đoán phù hợp</h5>';
            html += '<p class="text-muted">Vui lòng thử chọn triệu chứng khác hoặc liên hệ bác sĩ</p>';
            html += '</div>';
        }

        // Add general recommendations
        html += `
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i>Lưu ý quan trọng:</h6>
                <ul class="mb-0">
                    <li>Đây chỉ là chẩn đoán sơ bộ, không thay thế chẩn đoán của bác sĩ</li>
                    <li>Nếu triệu chứng nghiêm trọng, hãy đến bệnh viện ngay lập tức</li>
                    <li>Kết quả chẩn đoán đã được lưu vào hồ sơ sức khỏe của bạn</li>
                </ul>
            </div>
        `;

        resultsDiv.innerHTML = html;
        document.getElementById('diagnosisResults').style.display = 'block';
        
        // Scroll to results
        document.getElementById('diagnosisResults').scrollIntoView({ behavior: 'smooth' });
    }

    function saveDiagnosisToProfile(formData, diagnosis) {
        const diagnosisData = {
            user_id: '{{ user.id }}',
            age: formData.age,
            days_sick: formData.days_sick,
            symptoms: formData.symptoms,
            custom_symptoms: formData.custom_symptoms,
            profile_data: formData.profile_data,
            diagnosis: diagnosis,
            created_at: new Date().toISOString()
        };

        fetch('/api/firebase/save-diagnosis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(diagnosisData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Diagnosis saved to profile successfully');
            } else {
                console.error('Error saving diagnosis:', data.error);
            }
        })
        .catch(error => {
            console.error('Error saving diagnosis:', error);
        });
    }
</script>
{% endblock %}
